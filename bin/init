#!/usr/bin/env bash

esc() {
    echo "$1" | sed -E 's/(\/|\\)/\\\1/g'
}

fillTemplate() {
    cat "$1" \
    | sed -e "s/SwagPluginTemplate/$(esc "$PLUGIN_NAME")/g" \
    | sed -e "s/$(esc 'swag/plugin-template')/$(esc "$COMPOSER_NAME")/g" \
    | sed -e "s/$(esc 'Swag\PluginTemplate')/$(esc "$PHP_NAMESPACE")/g" \
    | sed -e "s/$(esc 'Swag\\PluginTemplate')/$(esc "$PHP_NAMESPACE_JSON")/g"
}

PLUGIN_NAME="$1"

echo -n "Plugin name? [$PLUGIN_NAME]: "
read -r answer
if [ "$answer" != "" ] ;then
    PLUGIN_NAME="$answer"
fi

SPLIT="$(echo "$PLUGIN_NAME" | sed -r 's/([a-z0-9])([A-Z])/\1\n\L\2/')"

PART1="$(echo "$SPLIT" | head -n1)"
PART2="$(echo "$SPLIT" | tail -n1)"

COMPOSER_NAME="$(echo "$PART1" | sed -r 's/([a-z0-9])([A-Z])/\1-\L\2/g')/$(echo "$PART2" | sed -r 's/([a-z0-9])([A-Z])/\1-\L\2/g')"
COMPOSER_NAME="$(echo "$COMPOSER_NAME" | tr '[:upper:]' '[:lower:]')"

echo -n "Composer name [$COMPOSER_NAME]: "
read -r answer
if [ "$answer" != "" ] ;then
    COMPOSER_NAME="$answer"
fi

PHP_NAMESPACE="${PART1^}\\${PART2^}"

echo -n "PHP namespace [$PHP_NAMESPACE]: "
read -r answer
if [ "$answer" != "" ] ;then
    PHP_NAMESPACE="$answer"
fi

PHP_NAMESPACE_JSON="$(esc "$PHP_NAMESPACE")"


NEW_COMPOSER="$(fillTemplate composer.json)"
echo "$NEW_COMPOSER" > composer.json

NEW_PLUGIN_CLASS="$(fillTemplate src/SwagPluginTemplate.php)"
echo "$NEW_PLUGIN_CLASS" > src/SwagPluginTemplate.php

mv src/SwagPluginTemplate.php "src/${PLUGIN_NAME}.php"

echo -n "Delete this script? (y/n)? "
read -r answer
if [ "$answer" != "${answer#[YyjJ]}" ] ;then
    rm "$0"
else
    echo No
fi

rm TEMPLATE

git diff
